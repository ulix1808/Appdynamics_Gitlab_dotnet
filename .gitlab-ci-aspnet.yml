# GitLab CI/CD Pipeline para ASP.NET con AppDynamics (Server Agent + RUM)
# Este pipeline automatiza la instrumentaci√≥n de AppDynamics para aplicaciones ASP.NET (.NET Framework)
# Incluye configuraci√≥n de RUM (Real User Monitoring) para monitoreo de frontend

stages:
  - build
  - configure
  - deploy

variables:
  BUILD_PATH: "./bin/Release"
  APPDYNAMICS_AGENT_PATH: "C:\\AppDynamics\\AppServerAgent"
  PROJECT_SOLUTION: "MyApplication.sln"
  RUM_SCRIPT_PATH: "./Scripts/appdynamics-rum.js"
  
# Nota: Este pipeline requiere un GitLab Runner con tags: [windows]

build:
  stage: build
  tags:
    - windows
  script:
    - echo "=== Restaurando paquetes NuGet ==="
    - nuget restore $PROJECT_SOLUTION
    
    - echo "=== Compilando aplicaci√≥n ASP.NET ==="
    - msbuild $PROJECT_SOLUTION /p:Configuration=Release /p:Platform="Any CPU" /t:Build
    
    - echo "=== Build completado ==="
  artifacts:
    paths:
      - $BUILD_PATH
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

configure_appdynamics:
  stage: configure
  tags:
    - windows
  before_script:
    # Verificar que las variables de CI/CD est√°n configuradas
    - if (-not $env:APPDYNAMICS_CONTROLLER_HOST) { throw "APPDYNAMICS_CONTROLLER_HOST no est√° configurado" }
    - if (-not $env:APPDYNAMICS_ACCOUNT_ACCESS_KEY) { throw "APPDYNAMICS_ACCOUNT_ACCESS_KEY no est√° configurado" }
    - if (-not $env:APPDYNAMICS_RUM_APP_KEY) { throw "APPDYNAMICS_RUM_APP_KEY no est√° configurado (necesario para RUM)" }
  script:
    - echo "=== Configurando AppDynamics Server Agent ==="
    
    # Crear directorio del agente si no existe
    - if (-not (Test-Path $APPDYNAMICS_AGENT_PATH)) {
        New-Item -ItemType Directory -Path $APPDYNAMICS_AGENT_PATH -Force
      }
    
    # Crear o actualizar controller-info.xml para Server Agent
    - $controllerInfoPath = "$APPDYNAMICS_AGENT_PATH\conf\controller-info.xml"
    - $confDir = "$APPDYNAMICS_AGENT_PATH\conf"
    - if (-not (Test-Path $confDir)) { New-Item -ItemType Directory -Path $confDir -Force }
    
    - $nodeName = if ($env:APPDYNAMICS_NODE_NAME) { $env:APPDYNAMICS_NODE_NAME } else { "$env:CI_COMMIT_REF_NAME-$env:CI_PIPELINE_ID" }
    
    - @"
<?xml version="1.0" encoding="UTF-8"?>
<controller-info>
    <controller-host>$env:APPDYNAMICS_CONTROLLER_HOST</controller-host>
    <controller-port>$env:APPDYNAMICS_CONTROLLER_PORT</controller-port>
    <controller-ssl-enabled>$env:APPDYNAMICS_CONTROLLER_SSL</controller-ssl-enabled>
    <account-name>$env:APPDYNAMICS_ACCOUNT_NAME</account-name>
    <account-access-key>$env:APPDYNAMICS_ACCOUNT_ACCESS_KEY</account-access-key>
    <application-name>$env:APPDYNAMICS_APP_NAME</application-name>
    <tier-name>$env:APPDYNAMICS_TIER_NAME</tier-name>
    <node-name>$nodeName</node-name>
    <sim-enabled>false</sim-enabled>
</controller-info>
"@ | Out-File -FilePath $controllerInfoPath -Encoding UTF8
    
    - echo "‚úÖ Server Agent configurado en: $controllerInfoPath"
    - echo "Controller: $env:APPDYNAMICS_CONTROLLER_HOST:$env:APPDYNAMICS_CONTROLLER_PORT"
    - echo "Application: $env:APPDYNAMICS_APP_NAME"
    - echo "Tier: $env:APPDYNAMICS_TIER_NAME"
    - echo "Node: $nodeName"
    
    # Verificar que el archivo se cre√≥ correctamente
    - if (Test-Path $controllerInfoPath) {
        echo "‚úÖ controller-info.xml creado exitosamente"
        Get-Content $controllerInfoPath | Select-Object -First 5
      } else {
        throw "‚ùå Error: No se pudo crear controller-info.xml"
      }
    
    - echo ""
    - echo "=== Configurando AppDynamics RUM (Real User Monitoring) ==="
    
    # Crear directorio para scripts RUM si no existe
    - $rumScriptsDir = "$BUILD_PATH\Scripts"
    - if (-not (Test-Path $rumScriptsDir)) { 
        New-Item -ItemType Directory -Path $rumScriptsDir -Force 
        echo "Directorio de scripts RUM creado: $rumScriptsDir"
      }
    
    # Generar script RUM de AppDynamics con configuraci√≥n din√°mica
    - $rumScriptPath = "$rumScriptsDir\appdynamics-rum.js"
    - $rumControllerHost = $env:APPDYNAMICS_CONTROLLER_HOST
    - $rumApplicationName = $env:APPDYNAMICS_APP_NAME
    - $rumTierName = $env:APPDYNAMICS_TIER_NAME
    - $rumAppKey = $env:APPDYNAMICS_RUM_APP_KEY
    - $rumBeaconUrl = if ($env:APPDYNAMICS_RUM_BEACON_URL) { $env:APPDYNAMICS_RUM_BEACON_URL } else { "https://$rumControllerHost/eumcollector" }
    
    - @"
// AppDynamics Real User Monitoring (RUM) JavaScript Agent
// Generado autom√°ticamente por GitLab CI/CD Pipeline

window['adrum-start-time'] = new Date().getTime();
(function(config){
    config.appKey = '$rumAppKey';
    config.adrumExtUrlHttp = '$rumBeaconUrl';
    config.adrumExtUrlHttps = '$rumBeaconUrl';
    config.beaconUrlHttp = '$rumBeaconUrl';
    config.beaconUrlHttps = '$rumBeaconUrl';
    config.applicationName = '$rumApplicationName';
    config.tierName = '$rumTierName';
    config.xd = {
        http: false,
        https: false
    };
    config.spa = {
        spa2: false,
        spa2Timer: false
    };
    config.adrumExtUrlHttp = 'http://$rumControllerHost/eumcollector';
    config.adrumExtUrlHttps = 'https://$rumControllerHost/eumcollector';
})(window['adrum-config'] || (window['adrum-config'] = {}));

// Cargar el script del agente RUM de AppDynamics
(function() {
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.async = true;
    script.src = (('https:' == document.location.protocol) ? 'https://' : 'http://') + '$rumControllerHost/adrum/adrum-latest.js';
    var firstScript = document.getElementsByTagName('script')[0];
    firstScript.parentNode.insertBefore(script, firstScript);
})();
"@ | Out-File -FilePath $rumScriptPath -Encoding UTF8
    
    - echo "‚úÖ Script RUM generado en: $rumScriptPath"
    - echo "RUM Application Key: $rumAppKey"
    - echo "RUM Beacon URL: $rumBeaconUrl"
    
    # Verificar que el script RUM se cre√≥ correctamente
    - if (Test-Path $rumScriptPath) {
        echo "‚úÖ appdynamics-rum.js creado exitosamente"
        echo "Tama√±o del archivo: $((Get-Item $rumScriptPath).Length) bytes"
      } else {
        throw "‚ùå Error: No se pudo crear appdynamics-rum.js"
      }
    
    - echo ""
    - echo "=== Generando snippet para _Layout.cshtml o Master Page ==="
    - $snippetPath = "$BUILD_PATH\AppDynamics-RUM-Snippet.txt"
    - @"
<!-- AppDynamics RUM JavaScript Agent -->
<!-- Agregar este c√≥digo ANTES del cierre de </head> en tu _Layout.cshtml o Master Page -->

<script src="~/Scripts/appdynamics-rum.js"></script>

<!-- O si prefieres usar la CDN de AppDynamics directamente, usa este c√≥digo: -->
<!--
<script>
    window['adrum-start-time'] = new Date().getTime();
    (function(config){
        config.appKey = '$rumAppKey';
        config.adrumExtUrlHttp = 'http://$rumControllerHost/eumcollector';
        config.adrumExtUrlHttps = 'https://$rumControllerHost/eumcollector';
        config.beaconUrlHttp = 'http://$rumControllerHost/eumcollector';
        config.beaconUrlHttps = 'https://$rumControllerHost/eumcollector';
        config.applicationName = '$rumApplicationName';
        config.tierName = '$rumTierName';
    })(window['adrum-config'] || (window['adrum-config'] = {}));
</script>
<script src="https://$rumControllerHost/adrum/adrum-latest.js"></script>
-->
"@ | Out-File -FilePath $snippetPath -Encoding UTF8
    
    - echo "‚úÖ Snippet de integraci√≥n generado en: $snippetPath"
    - echo "   Instrucciones: Agregar el c√≥digo al <head> de tu _Layout.cshtml o Master Page"
    
  dependencies:
    - build
  only:
    - main
    - develop

deploy:
  stage: deploy
  tags:
    - windows
  script:
    - echo "=== Desplegando aplicaci√≥n ASP.NET ==="
    
    # Variables de despliegue (ajustar seg√∫n tu configuraci√≥n)
    - $deployPath = "C:\inetpub\wwwroot\MyApp"
    - $appPoolName = "MyAppPool"
    
    # Crear directorio de despliegue si no existe
    - if (-not (Test-Path $deployPath)) { 
        New-Item -ItemType Directory -Path $deployPath -Force 
        echo "Directorio de despliegue creado: $deployPath"
      }
    
    # Detener Application Pool antes de copiar archivos
    - echo "=== Deteniendo Application Pool ==="
    - Import-Module WebAdministration -ErrorAction SilentlyContinue
    - if (Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue) {
        Stop-WebAppPool -Name $appPoolName
        echo "Application Pool detenido: $appPoolName"
        Start-Sleep -Seconds 3
      } else {
        echo "Application Pool no encontrado: $appPoolName (continuando...)"
      }
    
    # Copiar archivos al directorio de despliegue
    - echo "=== Copiando archivos de aplicaci√≥n ==="
    - Copy-Item -Path "$BUILD_PATH\*" -Destination $deployPath -Recurse -Force
    - echo "Archivos copiados exitosamente"
    
    # Verificar que los archivos RUM se copiaron
    - $rumScriptPath = "$deployPath\Scripts\appdynamics-rum.js"
    - if (Test-Path $rumScriptPath) {
        echo "‚úÖ Script RUM copiado exitosamente: $rumScriptPath"
      } else {
        echo "‚ö†Ô∏è  Advertencia: Script RUM no encontrado en: $rumScriptPath"
        echo "   Aseg√∫rate de que el script RUM est√© incluido en el build"
      }
    
    # Actualizar web.config con AppDynamics si es necesario (opcional)
    - $webConfigPath = "$deployPath\web.config"
    - if (Test-Path $webConfigPath) {
        echo "web.config encontrado en: $webConfigPath"
        echo "Nota: Verificar que AppDynamics est√° configurado en web.config"
        echo "      Verificar que el script RUM est√° referenciado en _Layout.cshtml o Master Page"
      } else {
        echo "‚ö†Ô∏è  web.config no encontrado en: $webConfigPath"
      }
    
    # Reiniciar Application Pool
    - echo "=== Reiniciando Application Pool ==="
    - if (Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue) {
        Start-WebAppPool -Name $appPoolName
        echo "Application Pool iniciado: $appPoolName"
        
        # Esperar a que el Application Pool est√© iniciado
        Start-Sleep -Seconds 5
        $poolState = (Get-WebAppPoolState -Name $appPoolName).Value
        if ($poolState -eq "Started") {
          echo "‚úÖ Application Pool iniciado correctamente"
        } else {
          echo "‚ö†Ô∏è  Application Pool en estado: $poolState"
        }
      } else {
        echo "‚ö†Ô∏è  Application Pool no encontrado: $appPoolName"
        echo "   Aseg√∫rate de que el nombre del Application Pool sea correcto"
      }
    
    # Opcional: Reiniciar sitio web completo (m√°s agresivo)
    # - $websiteName = "MyWebsite"
    # - Stop-Website -Name $websiteName
    # - Start-Website -Name $websiteName
    # - echo "Sitio web reiniciado: $websiteName"
    
    - echo ""
    - echo "‚úÖ Despliegue completado"
    - echo "üìã Pr√≥ximos pasos:"
    - echo "   1. Verificar que AppDynamics Server Agent est√° corriendo"
    - echo "   2. Verificar que el script RUM est√° incluido en _Layout.cshtml o Master Page"
    - echo "   3. Verificar conexi√≥n con AppDynamics Controller"
    - echo "   4. Verificar que RUM est√° enviando datos desde el navegador"
    
  dependencies:
    - build
    - configure_appdynamics
  environment:
    name: production
    url: https://myapp.example.com
  only:
    - main
