# GitLab CI/CD Pipeline SOLO RUM (Real User Monitoring) - Sin Server Agent
# Este pipeline solo configura RUM (monitoreo de frontend/browser) sin el agente de backend
# √ötil cuando solo necesitas monitorear la experiencia del usuario desde el navegador

stages:
  - build
  - configure
  - deploy

variables:
  BUILD_PATH: "./bin/Release"
  RUM_SCRIPT_PATH: "./Scripts/appdynamics-rum.js"
  
# Nota: Este pipeline NO requiere AppDynamics Server Agent instalado
# Solo necesita RUM Application Key de AppDynamics Controller

build:
  stage: build
  tags:
    - windows  # O cambiar a - linux seg√∫n tu caso
  script:
    - echo "=== Compilando aplicaci√≥n ==="
    - echo "Nota: Este pipeline es independiente del tipo de aplicaci√≥n"
    - echo "Funciona con: ASP.NET, .NET Core, .NET Framework, o cualquier aplicaci√≥n web"
    
    # Para .NET Framework / ASP.NET
    # - nuget restore MyApplication.sln
    # - msbuild MyApplication.sln /p:Configuration=Release /p:Platform="Any CPU" /t:Build
    
    # Para .NET Core
    # - dotnet restore
    # - dotnet build --configuration Release
    
    # Para otras aplicaciones web
    # - echo "Compilar tu aplicaci√≥n aqu√≠ seg√∫n corresponda"
    
    - echo "=== Build completado ==="
  artifacts:
    paths:
      - $BUILD_PATH
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

configure_rum:
  stage: configure
  tags:
    - windows  # O cambiar a - linux seg√∫n tu caso
  before_script:
    # Verificar que las variables de CI/CD est√°n configuradas para RUM
    - if (-not $env:APPDYNAMICS_CONTROLLER_HOST) { throw "APPDYNAMICS_CONTROLLER_HOST no est√° configurado" }
    - if (-not $env:APPDYNAMICS_RUM_APP_KEY) { throw "APPDYNAMICS_RUM_APP_KEY no est√° configurado (requerido para RUM)" }
    - echo "=== Configurando SOLO RUM (sin Server Agent) ==="
    - echo "Controller Host: $env:APPDYNAMICS_CONTROLLER_HOST"
    - echo "RUM App Key: $env:APPDYNAMICS_RUM_APP_KEY"
  script:
    - echo ""
    - echo "=== Generando script RUM de AppDynamics ==="
    
    # Crear directorio para scripts RUM si no existe
    - $rumScriptsDir = "$BUILD_PATH\Scripts"
    - if (-not (Test-Path $rumScriptsDir)) { 
        New-Item -ItemType Directory -Path $rumScriptsDir -Force 
        echo "Directorio de scripts RUM creado: $rumScriptsDir"
      }
    
    # Variables de configuraci√≥n RUM
    - $rumControllerHost = $env:APPDYNAMICS_CONTROLLER_HOST
    - $rumApplicationName = if ($env:APPDYNAMICS_APP_NAME) { $env:APPDYNAMICS_APP_NAME } else { "MyApplication" }
    - $rumTierName = if ($env:APPDYNAMICS_TIER_NAME) { $env:APPDYNAMICS_TIER_NAME } else { "Frontend" }
    - $rumAppKey = $env:APPDYNAMICS_RUM_APP_KEY
    - $rumBeaconUrl = if ($env:APPDYNAMICS_RUM_BEACON_URL) { $env:APPDYNAMICS_RUM_BEACON_URL } else { "https://$rumControllerHost/eumcollector" }
    
    # Generar script RUM de AppDynamics con configuraci√≥n din√°mica
    - $rumScriptPath = "$rumScriptsDir\appdynamics-rum.js"
    
    - @"
// AppDynamics Real User Monitoring (RUM) JavaScript Agent
// Generado autom√°ticamente por GitLab CI/CD Pipeline
// SOLO RUM - Sin Server Agent

window['adrum-start-time'] = new Date().getTime();
(function(config){
    config.appKey = '$rumAppKey';
    config.adrumExtUrlHttp = '$rumBeaconUrl';
    config.adrumExtUrlHttps = '$rumBeaconUrl';
    config.beaconUrlHttp = '$rumBeaconUrl';
    config.beaconUrlHttps = '$rumBeaconUrl';
    config.applicationName = '$rumApplicationName';
    config.tierName = '$rumTierName';
    config.xd = {
        http: false,
        https: false
    };
    config.spa = {
        spa2: false,
        spa2Timer: false
    };
    config.adrumExtUrlHttp = 'http://$rumControllerHost/eumcollector';
    config.adrumExtUrlHttps = 'https://$rumControllerHost/eumcollector';
})(window['adrum-config'] || (window['adrum-config'] = {}));

// Cargar el script del agente RUM de AppDynamics
(function() {
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.async = true;
    script.src = (('https:' == document.location.protocol) ? 'https://' : 'http://') + '$rumControllerHost/adrum/adrum-latest.js';
    var firstScript = document.getElementsByTagName('script')[0];
    firstScript.parentNode.insertBefore(script, firstScript);
})();
"@ | Out-File -FilePath $rumScriptPath -Encoding UTF8
    
    - echo "‚úÖ Script RUM generado en: $rumScriptPath"
    - echo "RUM Application Key: $rumAppKey"
    - echo "RUM Beacon URL: $rumBeaconUrl"
    - echo "Application Name: $rumApplicationName"
    - echo "Tier Name: $rumTierName"
    
    # Verificar que el script RUM se cre√≥ correctamente
    - if (Test-Path $rumScriptPath) {
        echo "‚úÖ appdynamics-rum.js creado exitosamente"
        $fileSize = (Get-Item $rumScriptPath).Length
        echo "Tama√±o del archivo: $fileSize bytes"
        echo "Primeras l√≠neas del script:"
        Get-Content $rumScriptPath | Select-Object -First 5
      } else {
        throw "‚ùå Error: No se pudo crear appdynamics-rum.js"
      }
    
    - echo ""
    - echo "=== Generando snippets de integraci√≥n ==="
    
    # Snippet para ASP.NET MVC / Razor Pages
    - $snippetAspNetPath = "$BUILD_PATH\AppDynamics-RUM-Snippet-ASP.NET.txt"
    - @"
<!-- AppDynamics RUM JavaScript Agent -->
<!-- SOLO RUM - Sin Server Agent -->
<!-- Agregar este c√≥digo ANTES del cierre de </head> en tu _Layout.cshtml o Master Page -->

<script src="~/Scripts/appdynamics-rum.js"></script>

<!-- O usando CDN directamente: -->
<!--
<script>
    window['adrum-start-time'] = new Date().getTime();
    (function(config){
        config.appKey = '$rumAppKey';
        config.adrumExtUrlHttp = 'http://$rumControllerHost/eumcollector';
        config.adrumExtUrlHttps = 'https://$rumControllerHost/eumcollector';
        config.beaconUrlHttp = 'http://$rumControllerHost/eumcollector';
        config.beaconUrlHttps = 'https://$rumControllerHost/eumcollector';
        config.applicationName = '$rumApplicationName';
        config.tierName = '$rumTierName';
    })(window['adrum-config'] || (window['adrum-config'] = {}));
</script>
<script src="https://$rumControllerHost/adrum/adrum-latest.js"></script>
-->
"@ | Out-File -FilePath $snippetAspNetPath -Encoding UTF8
    
    # Snippet gen√©rico para HTML est√°tico o otras aplicaciones web
    - $snippetGenericPath = "$BUILD_PATH\AppDynamics-RUM-Snippet-HTML.txt"
    - @"
<!-- AppDynamics RUM JavaScript Agent -->
<!-- SOLO RUM - Sin Server Agent -->
<!-- Agregar este c√≥digo ANTES del cierre de </head> en tu p√°gina HTML principal -->

<script src="/Scripts/appdynamics-rum.js"></script>

<!-- O usando CDN directamente: -->
<!--
<script>
    window['adrum-start-time'] = new Date().getTime();
    (function(config){
        config.appKey = '$rumAppKey';
        config.adrumExtUrlHttp = 'http://$rumControllerHost/eumcollector';
        config.adrumExtUrlHttps = 'https://$rumControllerHost/eumcollector';
        config.beaconUrlHttp = 'http://$rumControllerHost/eumcollector';
        config.beaconUrlHttps = 'https://$rumControllerHost/eumcollector';
        config.applicationName = '$rumApplicationName';
        config.tierName = '$rumTierName';
    })(window['adrum-config'] || (window['adrum-config'] = {}));
</script>
<script src="https://$rumControllerHost/adrum/adrum-latest.js"></script>
-->
"@ | Out-File -FilePath $snippetGenericPath -Encoding UTF8
    
    - echo "‚úÖ Snippets de integraci√≥n generados:"
    - echo "   - AppDynamics-RUM-Snippet-ASP.NET.txt (para ASP.NET MVC/Razor Pages)"
    - echo "   - AppDynamics-RUM-Snippet-HTML.txt (para HTML est√°tico o otras apps web)"
    - echo ""
    - echo "üìã Instrucciones:"
    - echo "   1. Copia el snippet correspondiente a tu aplicaci√≥n"
    - echo "   2. Agrega el c√≥digo ANTES del cierre de </head>"
    - echo "   3. Aseg√∫rate de que el script RUM est√© accesible en /Scripts/appdynamics-rum.js"
    
  dependencies:
    - build
  only:
    - main
    - develop

deploy:
  stage: deploy
  tags:
    - windows  # O cambiar a - linux seg√∫n tu caso
  script:
    - echo "=== Desplegando aplicaci√≥n (SOLO RUM) ==="
    - echo "Nota: Este pipeline NO requiere AppDynamics Server Agent instalado"
    - echo "Solo necesitas incluir el script RUM en tu aplicaci√≥n web"
    
    # Variables de despliegue (ajustar seg√∫n tu configuraci√≥n)
    - $deployPath = "C:\inetpub\wwwroot\MyApp"
    
    # Para IIS / Windows
    - if ($IsWindows -or $env:OS -like "*Windows*") {
        # Crear directorio de despliegue si no existe
        - if (-not (Test-Path $deployPath)) { 
            New-Item -ItemType Directory -Path $deployPath -Force 
            echo "Directorio de despliegue creado: $deployPath"
          }
        
        # Copiar archivos al directorio de despliegue
        - echo "=== Copiando archivos de aplicaci√≥n ==="
        - Copy-Item -Path "$BUILD_PATH\*" -Destination $deployPath -Recurse -Force
        - echo "Archivos copiados exitosamente"
        
        # Verificar que los archivos RUM se copiaron
        - $rumScriptPath = "$deployPath\Scripts\appdynamics-rum.js"
        - if (Test-Path $rumScriptPath) {
            echo "‚úÖ Script RUM copiado exitosamente: $rumScriptPath"
            echo "   Aseg√∫rate de agregar la referencia al script en tu p√°gina HTML principal"
          } else {
            echo "‚ö†Ô∏è  Advertencia: Script RUM no encontrado en: $rumScriptPath"
            echo "   Verifica que el script se gener√≥ correctamente en el stage 'configure_rum'"
          }
        
        # Para IIS: Reiniciar Application Pool si es necesario
        - $appPoolName = "MyAppPool"
        - if ($env:IIS_APP_POOL_NAME) { $appPoolName = $env:IIS_APP_POOL_NAME }
        
        - echo "=== Verificando Application Pool (opcional) ==="
        - Import-Module WebAdministration -ErrorAction SilentlyContinue
        - if (Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue) {
            echo "Application Pool encontrado: $appPoolName"
            $poolState = (Get-WebAppPoolState -Name $appPoolName).Value
            echo "Estado actual: $poolState"
            echo "Nota: Si hiciste cambios en archivos est√°ticos, considera reiniciar el Application Pool"
            echo "Comando opcional: Stop-WebAppPool -Name $appPoolName; Start-WebAppPool -Name $appPoolName"
          } else {
            echo "Application Pool no encontrado o no es IIS"
          }
      } else {
        # Para Linux / Otras plataformas
        - echo "=== Despliegue en Linux / Otra plataforma ==="
        - echo "Copia los archivos seg√∫n tu m√©todo de despliegue"
        - echo "Aseg√∫rate de incluir: Scripts/appdynamics-rum.js"
        - echo "Y agregar la referencia al script en tu HTML principal"
      }
    
    - echo ""
    - echo "‚úÖ Despliegue completado"
    - echo ""
    - echo "üìã Pr√≥ximos pasos:"
    - echo "   1. Verificar que appdynamics-rum.js est√° accesible en: /Scripts/appdynamics-rum.js"
    - echo "   2. Agregar el script RUM a tu p√°gina HTML principal (usar snippet generado)"
    - echo "   3. Verificar que RUM est√° enviando datos a AppDynamics Controller"
    - echo "   4. Revisar m√©tricas en: AppDynamics Controller > User Experience > Browser RUM"
    
  dependencies:
    - build
    - configure_rum
  environment:
    name: production
    url: https://myapp.example.com
  only:
    - main
