# GitLab CI/CD Pipeline para .NET Framework con AppDynamics
# Este pipeline automatiza la instrumentación de AppDynamics para aplicaciones .NET Framework

stages:
  - build
  - configure
  - deploy

variables:
  BUILD_PATH: "./bin/Release"
  APPDYNAMICS_AGENT_PATH: "C:\\AppDynamics\\AppServerAgent"
  PROJECT_SOLUTION: "MyApplication.sln"
  
# Nota: Este pipeline requiere un GitLab Runner con tags: [windows]

build:
  stage: build
  tags:
    - windows
  script:
    - echo "=== Restaurando paquetes NuGet ==="
    - nuget restore $PROJECT_SOLUTION
    
    - echo "=== Compilando aplicación ==="
    - msbuild $PROJECT_SOLUTION /p:Configuration=Release /p:Platform="Any CPU" /t:Build
    
    - echo "=== Build completado ==="
  artifacts:
    paths:
      - $BUILD_PATH
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests

configure_appdynamics:
  stage: configure
  tags:
    - windows
  before_script:
    # Verificar que las variables de CI/CD están configuradas
    - if (-not $env:APPDYNAMICS_CONTROLLER_HOST) { throw "APPDYNAMICS_CONTROLLER_HOST no está configurado" }
    - if (-not $env:APPDYNAMICS_ACCOUNT_ACCESS_KEY) { throw "APPDYNAMICS_ACCOUNT_ACCESS_KEY no está configurado" }
  script:
    - echo "=== Configurando AppDynamics Agent ==="
    
    # Crear directorio del agente si no existe
    - if (-not (Test-Path $APPDYNAMICS_AGENT_PATH)) {
        New-Item -ItemType Directory -Path $APPDYNAMICS_AGENT_PATH -Force
      }
    
    # Crear o actualizar controller-info.xml
    - $controllerInfoPath = "$APPDYNAMICS_AGENT_PATH\conf\controller-info.xml"
    - $confDir = "$APPDYNAMICS_AGENT_PATH\conf"
    - if (-not (Test-Path $confDir)) { New-Item -ItemType Directory -Path $confDir -Force }
    
    - $nodeName = if ($env:APPDYNAMICS_NODE_NAME) { $env:APPDYNAMICS_NODE_NAME } else { "$env:CI_COMMIT_REF_NAME-$env:CI_PIPELINE_ID" }
    
    - @"
<?xml version="1.0" encoding="UTF-8"?>
<controller-info>
    <controller-host>$env:APPDYNAMICS_CONTROLLER_HOST</controller-host>
    <controller-port>$env:APPDYNAMICS_CONTROLLER_PORT</controller-port>
    <controller-ssl-enabled>$env:APPDYNAMICS_CONTROLLER_SSL</controller-ssl-enabled>
    <account-name>$env:APPDYNAMICS_ACCOUNT_NAME</account-name>
    <account-access-key>$env:APPDYNAMICS_ACCOUNT_ACCESS_KEY</account-access-key>
    <application-name>$env:APPDYNAMICS_APP_NAME</application-name>
    <tier-name>$env:APPDYNAMICS_TIER_NAME</tier-name>
    <node-name>$nodeName</node-name>
    <sim-enabled>false</sim-enabled>
</controller-info>
"@ | Out-File -FilePath $controllerInfoPath -Encoding UTF8
    
    - echo "AppDynamics agent configurado en: $controllerInfoPath"
    - echo "Controller: $env:APPDYNAMICS_CONTROLLER_HOST:$env:APPDYNAMICS_CONTROLLER_PORT"
    - echo "Application: $env:APPDYNAMICS_APP_NAME"
    - echo "Tier: $env:APPDYNAMICS_TIER_NAME"
    - echo "Node: $nodeName"
    
    # Verificar que el archivo se creó correctamente
    - if (Test-Path $controllerInfoPath) {
        echo "✅ controller-info.xml creado exitosamente"
        Get-Content $controllerInfoPath | Select-Object -First 5
      } else {
        throw "❌ Error: No se pudo crear controller-info.xml"
      }
  dependencies:
    - build
  only:
    - main
    - develop

deploy:
  stage: deploy
  tags:
    - windows
  script:
    - echo "=== Desplegando aplicación ==="
    
    # Variables de despliegue (ajustar según tu configuración)
    - $deployPath = "C:\inetpub\wwwroot\MyApp"
    - $appPoolName = "MyAppPool"
    
    # Crear directorio de despliegue si no existe
    - if (-not (Test-Path $deployPath)) { 
        New-Item -ItemType Directory -Path $deployPath -Force 
        echo "Directorio de despliegue creado: $deployPath"
      }
    
    # Detener Application Pool antes de copiar archivos
    - echo "=== Deteniendo Application Pool ==="
    - Import-Module WebAdministration -ErrorAction SilentlyContinue
    - if (Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue) {
        Stop-WebAppPool -Name $appPoolName
        echo "Application Pool detenido: $appPoolName"
        Start-Sleep -Seconds 3
      } else {
        echo "Application Pool no encontrado: $appPoolName (continuando...)"
      }
    
    # Copiar archivos al directorio de despliegue
    - echo "=== Copiando archivos de aplicación ==="
    - Copy-Item -Path "$BUILD_PATH\*" -Destination $deployPath -Recurse -Force
    - echo "Archivos copiados exitosamente"
    
    # Actualizar web.config con AppDynamics si es necesario (opcional)
    - $webConfigPath = "$deployPath\web.config"
    - if (Test-Path $webConfigPath) {
        echo "web.config encontrado en: $webConfigPath"
        echo "Nota: Verificar que AppDynamics está configurado en web.config"
      }
    
    # Reiniciar Application Pool
    - echo "=== Reiniciando Application Pool ==="
    - if (Get-WebAppPoolState -Name $appPoolName -ErrorAction SilentlyContinue) {
        Start-WebAppPool -Name $appPoolName
        echo "Application Pool iniciado: $appPoolName"
        
        # Esperar a que el Application Pool esté iniciado
        Start-Sleep -Seconds 5
        $poolState = (Get-WebAppPoolState -Name $appPoolName).Value
        if ($poolState -eq "Started") {
          echo "✅ Application Pool iniciado correctamente"
        } else {
          echo "⚠️  Application Pool en estado: $poolState"
        }
      } else {
        echo "⚠️  Application Pool no encontrado: $appPoolName"
        echo "   Asegúrate de que el nombre del Application Pool sea correcto"
      }
    
    # Opcional: Reiniciar sitio web completo (más agresivo)
    # - $websiteName = "MyWebsite"
    # - Stop-Website -Name $websiteName
    # - Start-Website -Name $websiteName
    # - echo "Sitio web reiniciado: $websiteName"
    
    - echo "✅ Despliegue completado"
  dependencies:
    - build
    - configure_appdynamics
  environment:
    name: production
    url: https://myapp.example.com
  only:
    - main
